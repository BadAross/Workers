# Workers

**Workers** - это web-приложение предназначеное для работы с данными сотрудников. Приложение состоит из 2 частей-веб-интерфейса для работы с пользователем и библиотеки для взаимодействия с БД. 

### База данных
База данных состоит из 5 таблиц:
+ **Worker** - хранит информацию о сотрудниках. Связана с **Passport** и **Department**
+ **Passport** - хранит информацию о паспортных данных сотрудников. Связана с **PassportType**
+ **PassportType** - хранит типы паспортов.
+ **Company** - хранит данные компаний.
+ **Department** - хранит данные отделов компаний. Связана с **Company**

Вся основная информация хранится в таблице **Worker**. Эта таблица ***связывает в себе все остальные модели*** в 1 общую структуру. Паспортные данные ***были выделены в отдельную таблицу*** **Passport** так как ***предпологается что паспортные данные могут расширятся*** (местомы выдачи паспрота и т.д.). При этом предпологается что вся ***работа с паспортными данными происходит только через сотрудника***, и полностью связаны друг с другом. Так же, ***чтобы типы паспорта не пришлось прописывать каждый раз заново, эти данные так же вынесены в отдельную таблицу*** **PassportType** (можно было бы сделать таблицу "словарь данных" где по типу можно было бы получать нудные данные, но так как других типов которые можно было бы хранить нет, создана таблица только для типов паспортов).

### Проекты
#### Web-интерфейс
***Web-интерфейс предназначен для взаимодействия пользователя с системой***. Проект ***построен на базе ASP NET Core 8.0***. В проекте ***используются FastEndpoints и Swagger***. Реализованы 4 метода для работы с сиотрудниками:
+ **Добавление сотрудника**
+ **Удаление сотрудника**
+ **Получение списка сотрудников по фильтрам**
+ **Изменения данных сотрудника**

#### Библиотека
***Библиотека предназначена для работы с БД***. Проект ***использует FastEndpoint (для валидации), Dapper, FluentValidation, Npgsql***.

Взаимодействие с базой происходит через Dapper и Npgsql. Подключение можно получить через `IDbManager.GetConnection`. Вызов методов с запросами происходит в `WorkerService`, взаимодействе с ним происходит через `IWorkerService`, который и вызывается в контройлерах. Реализация sql-запросов нахоидтся в `WorkerRepository` взаимодействие с которым происходит через `IWorkerRepository`.

##### Инициализация базы
При запуске приложения вызывается метод `NpgsqlInitializer.InitializeDb` который проверяет наличие БД, и инициализирует ее при необходимости. Запросы на инициализацию хранятся так же в `NpgsqlInitializer`, название схемы и таблиц для всех запросов берется из `NpgsqlDbConstants`. Это сделано для того чтобы если для инициализации название было изменено, не приходилось изменять его и в других запросах. Для отключение инициализации БД необходимо закоментировать строку `await NpgsqlInitializer.InitializeDb(builder.Configuration);` в `ServiceExtension`, который предназначен для регистрации необходимых для библиотеки ресрусов и вызывается в `Program`. 

***Инициализацию БД так же можно провести с помощью скрипта CreateDb в папке script. Так же в папке находится скрипт для заполнения тестовыми данными TestData***.

##### Валидация данных
Валидация входных данных реализова с помощью FastEndpoint и FluentValidation. Правила валидации прописаны в папке `Validators`.

##### Атрибуты для Dapper
В ходе выполнения задачи появилась необходимость использовать атрибут Column для указания названия поля. Было найдено ([Ссылка на реализацию](https://stackoverflow.com/questions/20951531/dapper-with-attributes-mapping)) и реализовано решение регистрации данного атрибута, которая находится в `Extensions.DapperAttributeMapper`.